{% extends "base.html" %}

{% block page_title %}Add New Deck{% endblock %}

{% block content %}
<div class="add-deck-container">
    <!-- Left Column: Form -->
    <div class="form-column">
        <div class="card form-card">
            <h3>Create a New Deck</h3>
            {% if message %}
                <p class="message" style="background-color: #dff0d8; color: #3c763d;">{{ message }}</p>
            {% endif %}
            {% if error %}
                <p class="message" style="background-color: #f2dede; color: #a94442;">{{ error }}</p>
            {% endif %}

            <form action="/add_deck" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="name">Deck Name:</label>
                    <input type="text" id="name" name="name" value="{{ name or '' }}" autocomplete="off" required>
                </div>

                <div class="form-group">
                    <label for="media_folder">Media Folder Name (Optional):</label>
                    <input type="text" id="media_folder" name="media_folder" value="{{ media_folder or '' }}" autocomplete="off">
                    <small style="display: block; margin-top: 5px;">
                        The name of the folder inside `/media/` where assets for this deck are stored. Leave blank if no media is used.
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="card_template">Card Template (Jinja2 HTML):</label>
                    <textarea id="card_template" name="card_template" rows="14" style="width: 100%; font-family: monospace; padding: 5px;" required>
{%- if card_template -%}
{{- card_template -}}
{%- else -%}
{%- raw -%}
<div class="kanji-card" id="kanjiCard">
    <div class="kanji-character">{{ card.data.front }}</div>
    
    <div class="kanji-meaning" id="cardBack" style="display: none;">
        <p><strong>Answer:</strong> {{ card.data.back }}</p>

        <audio controls src="/media/{{ deck.media_folder }}/{{ card.data.audio }}">
            Your browser does not support the audio element.
        </audio>
    </div>

    <button type="button" id="toggleBtn" class="btn btn-show-hide">Show Answer</button>
</div>
{%- endraw -%}
{%- endif -%}
</textarea>
                <small style="display: block;">
                    Use `{% raw %}{{ card.data.key }}{% endraw %}` to access card data.
                </small>
                <small style="display: block;">
                    For media src paths, use `{% raw %}/media/{{ deck.media_folder }}/{{ card.data.audio }}{% endraw %}`.
                </small>
                </div>

                <div class="form-group">
                    <label for="card_css">Card CSS:</label>
                    <textarea id="card_css" name="card_css" rows="10" style="width: 100%; font-family: monospace; padding: 5px;" required>
{%- if card_css -%}
{{- card_css -}}
{%- else -%}
.kanji-card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: inline-block; min-width: 300px; text-align: center;}
.kanji-character { font-size: 80px; margin-bottom: 20px; }
.kanji-meaning { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
.btn-show-hide { margin-top: 20px; background-color: #95a5a6; color: white; }
{%- endif -%}
</textarea>
                <small>Your card template will be wrapped around
                    {{ '<div class="card-container" style="text-align: center;">card template</div>.' | e }}
                </small>
                </div>
                
                <div class="form-group">
                    <label for="deck_file">Deck Data (JSON file):</label>
                    <input type="file" id="deck_file" name="deck_file" accept=".json" required>
                    <small style="display: block; margin-top: 5px;">
                        The file must be a JSON array of objects, e.g., `[{"front": "Q1", "back": "A1", "audio": "sound.mp3"}, ...]`
                    </small>
                </div>            
                <button type="submit" class="btn btn-primary">Create Deck</button>
            </form>
        </div>
    </div>

    <!-- Right Column: Live Preview -->
    <div class="preview-column">
        <div class="card">            
             <h3 style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <span>Card Preview</span>
                <button type="button" id="refreshPreviewBtn" title="Refresh Preview" class="btn btn-secondary" style="padding: 5px 10px; background-color: inherit; color: #95a5a6;"><i class="fas fa-redo"></i></button>
            </h3>
            <div id="card-preview-area" class="card-preview-placeholder">
                <p>Upload the Deck data using the form on the left to see a preview of your card.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}